"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[6011],{1589:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>d,default:()=>u,frontMatter:()=>i,metadata:()=>o,toc:()=>c});var s=r(5893),t=r(1151);const i={sidebar_position:10},d="express05",o={id:"Node.js/Express05",title:"express05",description:"csrf \u653b\u51fb",source:"@site/docs/Node.js/Express05.md",sourceDirName:"Node.js",slug:"/Node.js/Express05",permalink:"/docs/Node.js/Express05",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:10,frontMatter:{sidebar_position:10},sidebar:"tutorialSidebar",previous:{title:"express04",permalink:"/docs/Node.js/Express04"},next:{title:"Rest+Ajax",permalink:"/docs/category/restajax"}},l={},c=[{value:"csrf \u653b\u51fb",id:"csrf-\u653b\u51fb",level:2}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",li:"li",pre:"pre",ul:"ul",...(0,t.a)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.h1,{id:"express05",children:"express05"}),"\n",(0,s.jsx)(n.h2,{id:"csrf-\u653b\u51fb",children:"csrf \u653b\u51fb"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\u8de8\u7ad9\u8bf7\u6c42\u4f2a\u9020","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"http://localhost:3000/students/delete/4",children:"http://localhost:3000/students/delete/4"})}),"\n",(0,s.jsx)(n.li,{children:"\u73b0\u5728\u5927\u90e8\u5206\u7684\u6d4f\u89c8\u5668\u90fd\u4e0d\u4f1a\u5728\u8de8\u57df\u7684\u60c5\u51b5\u4e0b\u81ea\u52a8\u53d1\u9001 cookie"}),"\n",(0,s.jsx)(n.li,{children:"\u8fd9\u4e2a\u8bbe\u8ba1\u5c31\u662f\u4e3a\u4e86\u907f\u514d csrf \u7684\u653b\u51fb"}),"\n",(0,s.jsxs)(n.li,{children:["\u5982\u4f55\u89e3\u51b3\uff1f","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u4f7f\u7528 referer \u5934\u6765\u68c0\u67e5\u8bf7\u6c42\u7684\u6765\u6e90"}),"\n",(0,s.jsx)(n.li,{children:"\u4f7f\u7528\u9a8c\u8bc1\u7801"}),"\n",(0,s.jsx)(n.li,{children:"\u5c3d\u91cf\u4f7f\u7528 post \u8bf7\u6c42(\u7ed3\u5408 token)"}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["token(\u4ee4\u724c)","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"\u53ef\u4ee5\u5728\u521b\u5efa\u8868\u5355\u65f6\u968f\u673a\u751f\u6210\u4e00\u4e2a\u4ee4\u724c"}),"\n",(0,s.jsx)(n.li,{children:"\u7136\u540e\u5c06\u4ee4\u724c\u5b58\u50a8\u5230 session \u4e2d\uff0c\u5e76\u901a\u8fc7 ejs \u6a21\u677f\u53d1\u9001\u7ed9\u7528\u6237"}),"\n",(0,s.jsx)(n.li,{children:"\u7528\u6237\u63d0\u4ea4\u8868\u5355\u65f6\uff0c\u5fc5\u987b\u5c06 token \u53d1\u56de\uff0c\u624d\u53ef\u4ee5\u8fdb\u884c\u540e\u7eed\u64cd\u4f5c (\u53ef\u4ee5\u4f7f\u7528 uuid \u6765\u751f\u6210 token)"}),"\n",(0,s.jsxs)(n.li,{children:["\u4f7f\u7528\uff1a","\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"yarn add uuid"}),"\n",(0,s.jsx)(n.li,{children:"const uuid = require('uuid').v4"}),"\n",(0,s.jsx)(n.li,{children:"const token = uuid()"}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"// \u6743\u9650\u9a8c\u8bc1\r\napp.use((req, res, next) => {\r\n  // const referer = req.get('referer')\r\n\r\n  // if (!referer || !referer.startsWith('http://localhost:3000/')) {\r\n  //   res.status(403).send('\u4f60\u6ca1\u6709\u6743\u9650')\r\n  //   return\r\n  // }\r\n\r\n  if (req.session.loginUser) {\r\n    next()\r\n  } else {\r\n    res.redirect('/')\r\n  }\r\n})\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"// \u83b7\u53d6\u5b66\u751f\u4fe1\u606f\u7684\u8def\u7531\r\nrouter.get('/list', (req, res) => {\r\n  const token = uuid()\r\n  req.session.token = token\r\n  req.session.save(() => {\r\n    res.render('students', { STUDENT, username: req.session.loginUser, token })\r\n  })\r\n})\n"})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:'<form action="/students/add" method="post">\r\n  <div>\r\n    <input type="hidden" name="token" value="<%=token%>" />\r\n  </div>\r\n  <div>\r\n    \u59d3\u540d\uff1a\r\n    <input type="text" name="name" />\r\n  </div>\r\n  <div>\r\n    \u5e74\u9f84\uff1a\r\n    <input type="text" name="age" />\r\n  </div>\r\n  <div>\r\n    \u6027\u522b\uff1a\r\n    <input type="radio" name="gender" value="\u7537" />\u7537\r\n    <input type="radio" name="gender" value="\u5973" />\u5973\r\n  </div>\r\n  <div>\r\n    \u5730\u5740\uff1a\r\n    <input type="text" name="address" />\r\n  </div>\r\n  <div>\r\n    <button>\u6dfb\u52a0</button>\r\n  </div>\r\n</form>\n'})}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-js",children:"// \u6dfb\u52a0\u5b66\u751f\u7684\u8def\u7531\r\nrouter.post('/add', (req, res, next) => {\r\n  const token = req.body.token\r\n\r\n  if (token === req.session.token) {\r\n    const { name, age, gender, address } = req.body\r\n    const id = STUDENT.length > 0 ? STUDENT.at(-1).id + 1 : 1\r\n\r\n    const newStudent = {\r\n      id,\r\n      name,\r\n      age: +age,\r\n      gender,\r\n      address,\r\n    }\r\n\r\n    STUDENT.push(newStudent)\r\n\r\n    // \u6e05\u7a7atoken\r\n    req.session.token = null\r\n\r\n    next()\r\n  } else {\r\n    res.status(403).send('token\u65e0\u6548')\r\n  }\r\n})\n"})})]})}function u(e={}){const{wrapper:n}={...(0,t.a)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(a,{...e})}):a(e)}},1151:(e,n,r)=>{r.d(n,{Z:()=>o,a:()=>d});var s=r(7294);const t={},i=s.createContext(t);function d(e){const n=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:d(e.components),s.createElement(i.Provider,{value:n},e.children)}}}]);